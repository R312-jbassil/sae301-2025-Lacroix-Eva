---
//@ts-nocheck
import "../../../styles/global.css";
import Header from "../../../components/Header.astro";
import pb from "../../../../pocketbase/pb";
import {
  Collections,
  type SvgsRecord,
} from "../../../../pocketbase/pocketbase-types";

const id = Astro.params.id;
const svg: SvgsRecord = await pb.collection(Collections.Lunette).getOne(id);
const svgCodeEscaped = svg.code_svg.replace(/`/g, "\\`"); // échappe les backticks
---

<html lang="fr" data-theme="SAE301">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Personnalisation du modèle | TaVue</title>
  </head>
  <body>
    <Header />
    <main class="container mx-auto px-6 py-10">
      <h1 class="text-4xl font-bold text-primary mb-6 text-center">
        Personnalisez votre modèle
      </h1>

      <!-- Aperçu du SVG -->
      <section class="flex justify-center mb-10">
        <div id="svg-preview" class="w-full max-w-lg"></div>
      </section>

      <!-- Formulaire de personnalisation -->
      <section class="bg-base-200 p-6 rounded-xl shadow-md max-w-2xl mx-auto">
        <form id="customization-form" class="flex flex-col gap-4">
          <label class="flex flex-col">
            Matériau de la monture
            <select id="monture-material" class="input input-bordered">
              <option value="#706f6f">Acier</option>
              <option value="#8B4513">Acajou</option>
              <option value="#000000">Noir</option>
            </select>
          </label>

          <label class="flex flex-col">
            Couleur des branches
            <input
              type="color"
              id="branches-color"
              value="#706f6f"
              class="w-full h-10 p-0 border-0"
            />
          </label>

          <label class="flex flex-col">
            Largeur du pont (px)
            <input
              type="number"
              id="bridge-width"
              value="10"
              min="5"
              max="30"
              class="input input-bordered"
            />
          </label>

          <label class="flex flex-col">
            Taille des verres (px)
            <input
              type="number"
              id="lens-size"
              value="50"
              min="20"
              max="100"
              class="input input-bordered"
            />
          </label>
        </form>

        <div class="flex gap-2 mt-4">
          <button id="apply-customization" class="btn btn-primary">
            Appliquer la personnalisation
          </button>
          <button id="save-svg" class="btn btn-accent" data-id={svg.id}>
            Sauvegarder ma création
          </button>
        </div>
      </section>
    </main>

    <script type="module">
      const svgPreview = document.getElementById("svg-preview");

      // Injection du SVG côté client
      const svgCode = `\`${svgCodeEscaped}\``;
      svgPreview.innerHTML = eval(svgCode); // Eval pour transformer la string en DOM réel

      const applyBtn = document.getElementById("apply-customization");
      const saveBtn = document.getElementById("save-svg");

      function updateSVG() {
        const svgEl = svgPreview.querySelector("svg");
        if (!svgEl) return;

        const montureColor = document.getElementById("monture-material").value;
        const branchesColor = document.getElementById("branches-color").value;
        const bridgeWidth = parseInt(
          document.getElementById("bridge-width").value
        );
        const lensSize = parseInt(document.getElementById("lens-size").value);

        const monture = svgEl.querySelector("#monture path.cls-4");
        const branches = svgEl.querySelectorAll(
          "#branches path.cls-1, #branches path.cls-4"
        );
        const verres = svgEl.querySelectorAll("#verres path");

        if (monture) {
          monture.setAttribute("stroke", montureColor);
          monture.setAttribute("stroke-width", bridgeWidth);
        }
        branches.forEach((b) => b.setAttribute("fill", branchesColor));
        verres.forEach((v) => v.setAttribute("opacity", lensSize / 100));
      }

      applyBtn.addEventListener("click", updateSVG);

      saveBtn.addEventListener("click", async () => {
        const svgEl = svgPreview.querySelector("svg");
        if (!svgEl) return;

        const updatedSVG = svgEl.outerHTML;
        const svgId = saveBtn.dataset.id;

        try {
          const res = await fetch("/api2/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: svgId, code_svg: updatedSVG }),
          });
          const data = await res.json();
          if (data.success) alert("SVG sauvegardé !");
          else alert("Erreur : " + JSON.stringify(data));
        } catch (err) {
          console.error(err);
          alert("Erreur lors de la sauvegarde");
        }
      });

      // Applique la personnalisation par défaut au chargement
      window.addEventListener("load", updateSVG);
    </script>
  </body>
</html>
