---
//@ts-nocheck
import "../../styles/global.css";
import Header from "../../components/Header.astro";
import pb from "../../../pocketbase/pb";
import {
  Collections,
  type SvgsRecord,
} from "../../../pocketbase/pocketbase-types";

const id = Astro.params.id;
const svg: SvgsRecord = await pb.collection(Collections.Lunette).getOne(id);

// Parse de l'historique stocké (string → tableau)
let history = [];
if (Array.isArray(svg?.chat_history)) {
  history = svg.chat_history;
} else {
  try {
    history = JSON.parse(svg?.chat_history || "[]");
  } catch {
    history = [];
  }
}
---

<!doctype html>
<html lang="fr" data-theme="SAE301">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>
      TaVue – Crée tes lunettes personnalisées | Style & Fabrication française
    </title>
    <meta
      name="description"
      content="Configurez vos lunettes sur mesure, visualisez-les en temps réel et commandez-les. Élégance minimaliste, fabrication française."
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "TaVue",
        "url": "https://sae301.eva-lacroix.fr",
        "description": "Site pour configurer des lunettes personnalisées en ligne.",
        "applicationCategory": "DesignApplication",
        "operatingSystem": "Web",
        "offers": {
          "@type": "Offer",
          "price": "0.00",
          "priceCurrency": "EUR",
          "description": "Configuration gratuite."
        }
      }
    </script>
  </head>

  <body>
    <Header />

    <main class="container mx-auto p-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Preview -->
        <section class="bg-base-200 rounded-lg p-6 flex flex-col gap-4">
          <div class="flex items-start justify-between">
            <h4 class="lg:text-2xl font-semibold mb-2">Aperçu</h4>
            <div class="flex gap-2">
              <button id="download-svg" class="btn btn-sm">Télécharger</button>
            </div>
          </div>

          <div
            id="svg-preview"
            class="w-full flex justify-center items-center min-h-80 p-4 border rounded-lg bg-white"
          >
            <!-- server-rendered SVG preview -->
            <div set:html={svg?.code_svg} />
          </div>

          <div class="flex gap-3 text-sm text-muted">
            <div class="badge">ID: {svg?.id}</div>
            <div class="badge">
              Créé: {new Date(svg?.created || Date.now()).toLocaleDateString()}
            </div>
            <div class="badge">Visites: {svg?.visits || 0}</div>
          </div>
        </section>

        <!-- Right: Product card -->
        <aside class="flex flex-col gap-4">
          <div class="card bg-base-100 shadow-md p-6">
            <div class="flex justify-between items-start gap-4">
              <div>
                <h4 class="lg:text-2xl font-semibold mb-2">
                  {svg?.name || "Lunettes personnalisées"}
                </h4>
                <p class="text-sm text-muted mt-1">
                  {
                    svg?.description ||
                      "Design minimaliste, fabrication française."
                  }
                </p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-extrabold">
                  {svg?.prix ? `${svg.prix} €` : "99,00 €"}
                </div>
                <div class="text-sm text-muted">TVA incl.</div>
              </div>
            </div>

            <div class="divider my-4"></div>

            <div class="flex flex-col gap-3">

              <div class="flex items-center gap-3">
                <input
                  id="quantity"
                  type="number"
                  min="1"
                  value="1"
                  class="input input-bordered w-24"
                />
                <button id="add-to-cart" class="btn btn-primary flex-1"
                  >Ajouter au panier</button
                >
              </div>

              <button id="buy-now" class="btn btn-accent"
                >Acheter maintenant</button
              >
            </div>
          </div>

          <!-- Chat history card -->
          <div
            class="card bg-base-100 shadow p-4 overflow-y-auto max-h-[420px]"
            id="chat-container"
          >
            <h3 class="font-bold mb-2">Historique de chat</h3>
            <div id="chat-history" class="flex flex-col gap-4 p-2">
              {
                Array.isArray(history) && history.length > 0 ? (
                  history.map((msg: { role: string; content: string }) => (
                    <div
                      class={`chat ${msg.role === "user" ? "chat-start" : "chat-end"}`}
                    >
                      <div
                        class={`chat-bubble ${msg.role === "user" ? "bg-primary text-primary-content" : "bg-secondary text-secondary-content"}`}
                      >
                        <pre class="whitespace-pre-wrap">{msg.content}</pre>
                      </div>
                      <div class="chat-footer opacity-60 text-xs mt-1">
                        {msg.role}
                      </div>
                    </div>
                  ))
                ) : (
                  <span class="text-error">
                    Aucun historique de chat trouvé.
                  </span>
                )
              }
            </div>
          </div>
        </aside>
      </div>

      <!-- Sticky prompt form (kept for quick edits) -->
      <form
        id="input-prompt-form"
        class="fixed bottom-4 left-1/2 transform -translate-x-1/2 w-full max-w-3xl bg-base-300 p-4 rounded-lg shadow-lg flex gap-2 items-center"
        method="POST"
        autocomplete="off"
      >
        <input type="hidden" name="history" value={JSON.stringify(history)} />
        <input type="hidden" name="id" value={svg?.id} />
        <input
          id="prompt-input"
          name="editPrompt"
          type="text"
          class="input input-bordered grow"
          placeholder="Entrez votre prompt ici"
          required
        />
        <button class="btn btn-primary" type="submit">Modifier</button>
      </form>
    </main>

    <script>
      //@ts-nocheck
      const form = document.getElementById("input-prompt-form");
      const svgPreview = document.getElementById("svg-preview");
      const chatHistory = document.getElementById("chat-history");

      async function generateSVG(messages) {
        const res = await fetch("/api2/generateSVG", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(messages),
        });
        const data = await res.json();
        return data.svg?.content || "";
      }

      // Download SVG as file
      document.getElementById("download-svg")?.addEventListener("click", () => {
        const svgHtml = svgPreview.innerHTML || "";
        if (!svgHtml) return alert("Aucun SVG à télécharger");
        const blob = new Blob([svgHtml], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${svg?.nom || "lunettes"}.svg`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        let prompt = {
          role: "user",
          content: formData.get("editPrompt"),
        };

        let history = JSON.parse(formData.get("history") || "[]");
        const svgId = formData.get("id");
        history.push(prompt);

        document.getElementById("prompt-input").value = "";

        svgPreview.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;

        // Append user message to chat
        chatHistory.innerHTML += `
                <div class="chat chat-start">
                    <div class="chat-bubble bg-primary text-primary-content"><pre>${prompt.content}</pre></div>
                    <div class="chat-footer opacity-60 text-xs mt-1">user</div>
                </div>
            `;

        let aiResponse = await generateSVG(history);
        history.push({ role: "assistant", content: aiResponse });

        const svgMatch = aiResponse.match(/<svg[\s\S]*?<\/svg>/i);
        const svgCode = svgMatch ? svgMatch[0] : "";

        svgPreview.innerHTML = svgCode;
        chatHistory.innerHTML += `
                <div class="chat chat-end">
                    <div class="chat-bubble bg-secondary text-secondary-content"><pre>${svgCode}</pre></div>
                    <div class="chat-footer opacity-60 text-xs mt-1">assistant</div>
                </div>
            `;

        async function update(updatedData) {
          const response = await fetch("/api2/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData),
          });
          return await response.json();
        }

        const response = await update({
          id: svgId,
          code_svg: svgPreview.innerHTML,
          chat_history: JSON.stringify(history),
        });

        if (response?.success) {
          // small non-intrusive toast (fallback to alert)
          try {
            window?.toast?.("SVG mis à jour");
          } catch {
            /* ignore */
          }
        } else {
          alert(
            "Échec de la mise à jour : " +
              (response?.error || "Erreur inconnue")
          );
        }
        form.reset();
      });

      // Add-to-cart / buy-now small handlers
      document.getElementById("add-to-cart")?.addEventListener("click", () => {
        const qty = Number(
          (document.getElementById("quantity") as HTMLInputElement)?.value || 1
        );
        alert(`Ajouté au panier : ${qty} × ${svg?.nom || "Lunettes"}`);
      });
      document.getElementById("buy-now")?.addEventListener("click", () => {
        alert("Redirection vers la caisse (simulation)");
      });
    </script>
  </body>
</html>
